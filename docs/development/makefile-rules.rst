.. makefile-rules:

==============
Makefile rules
==============

The repo has a ``Makefile`` to help with development. Some of the rules depend on having
``uv`` installed.

Always run ``make`` from the root of the repository.

Rules for development setup
===========================

install
-------

Runs ``uv sync --extra dev`` to create a virtual environment and install all
dependencies including dev extras.

run
---

Runs the Django development server via ``uv run manage.py runserver``.

create-env
----------

Creates a new environment file from ``.env.template``::

    $ make create-env dev

This creates ``.env.dev`` with the template values for you to fill in.
Will refuse to overwrite an existing file.

set-env
-------

Switches between multiple environment configurations. Environment files are
named by suffix, e.g. ``.env.dev``, ``.env.test``.

List available environments::

    $ make set-env

Select an environment::

    $ make set-env dev

This creates a symlink from ``.env.<name>`` to ``.env``, which ``uv run``
picks up automatically. If ``.env`` is a regular file, the command will refuse
to overwrite it and ask you to rename it first.

Rules that delete files
=======================

clean
-----

Deletes files generated by python.

cacheclean
----------

Deletes auto-generated files that aren't covered by any other rule. Good place
for adding new files to delete.

distclean
---------

Deletes files generated on package build, including the packages. Useful
*before* making a new release.

docclean
--------

Deletes the files generated on running the ``Makefile`` in ``docs/``.

coverageclean
-------------

Deletes files created by ``coverage``, which happens if running tests with ``tox``.

testclean
---------

Runs ``coverageclean``, ``clean``, *and* deletes ``.tox``. Useful when there is
*something wrong* when running tests and you need a brutal way to get rid of
extraneous files. ``tox`` will have to spend time on re-building its
virtualenvs afterwards.

nuke
----

Runs all the cleaning jobs. This + ``git stash -u`` should reset the repository
to a pristine state. If something's wrong, don't call Ghostbusters, ``make
nuke`` instead.

Rules that generate files
=========================

tailwind
--------

Assumes that the standalone tailwind CLI client is downloaded and uses the
tailwind configuration in ``src/argus/htmx/tailwindtheme`` to generate
a stylesheet that is put in ``src/argus/htmx/static/styles.css``.

This rule can be used together with the ``tailwind_config`` management command
when when changing styles or themeing::

    $ python3 manage.py tailwind_config && make tailwind

upgrade-tailwind
----------------

Uses the confguration in ``src/argus/htmx/tailwindtheme/config.py`` to download
a standalone version of the tailwind compiler (the one used by the ``tailwind``
rule) and the tailwind- and Daisy UI files to be used by that compiler.

This ensures that everybody is using the same version of tailwind and prevents
generating unnecessary versions of ``src/argus/htmx/static/styles.css`` just
because there are different patch revisions of tailwind used by different
developers.

The version in the config is for one of the releases at
`dobicinaitis' tailwind-cli-extra <https://github.com/dobicinaitis/tailwind-cli-extra/releases/>`_

After a change in version, running ``upgrade-tailwind`` should be followed by
running::

    $ python3 manage.py tailwind_config && make tailwind

... and a commit so that the correct ``src/argus/htmx/static/styles.css`` is
available to everyone.
