{% load widget_tweaks %}
<div id="destination-table" class="card card-base max-w-4xl w-full">
  <div class="card-body p-4">
    {% if error_msg %}
      {% include "messages/_banner.html" with message=error_msg level="error" %}
    {% endif %}
    {% if success_message %}
      {% include "messages/_banner.html" with message=success_message level="success" %}
    {% endif %}
    <div class="overflow-x-auto">
      <table class="table [&_td]:align-top">
        <thead>
          <tr>
            <th class="w-[150px]">Media</th>
            <th>Name</th>
            <th>Value</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr id="destination-create"></tr>
          {% for form in update_forms %}
            <tr class="align-top">
              <td>
                {% csrf_token %}
                {% for hidden_field in form.hidden_fields %}{{ hidden_field }}{% endfor %}
                <span class="badge badge-outline mt-1.5">{{ form.instance.media.name }}</span>
              </td>
              <td>
                {% render_field form.label class+="input input-bordered input-sm w-full" %}
                {% for error in form.label.errors %}<span class="text-error text-xs">{{ error }}</span>{% endfor %}
              </td>
              <td>
                {% render_field form.settings class+="input input-bordered input-sm w-full" %}
                {% for error in form.settings.errors %}<span class="text-error text-xs">{{ error }}</span>{% endfor %}
              </td>
              <td>
                <div class="flex gap-1 items-center">
                  <button type="button"
                          hx-post="{% url 'htmx:destination-update' pk=form.instance.pk %}"
                          hx-include="closest tr"
                          hx-target="#destination-table"
                          hx-swap="outerHTML"
                          class="btn btn-primary btn-sm">Save</button>
                  {% if form.delete_disabled %}
                    <span class="tooltip tooltip-left tooltip-info cursor-not-allowed"
                          data-tip="{{ form.delete_tooltip }}">
                      <button class="btn btn-sm btn-outline btn-error" disabled>Delete</button>
                    </span>
                  {% else %}
                    {% include form.modal.template_name with modal=form.modal %}
                  {% endif %}
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4" class="text-base-content/60 text-center">No destinations yet.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<dialog id="unsaved-changes-dialog" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold">Unsaved changes</h3>
    <p class="py-4">You have unsaved changes. Are you sure you want to leave?</p>
    <div class="modal-action">
      <button class="btn btn-error" id="unsaved-changes-leave">Leave</button>
      <button class="btn" id="unsaved-changes-stay">Stay</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
<script>
(() => {
  const table = document.getElementById("destination-table");
  if (!table) return;

  const dialog = document.getElementById("unsaved-changes-dialog");
  const leaveBtn = document.getElementById("unsaved-changes-leave");
  const stayBtn = document.getElementById("unsaved-changes-stay");

  const hasDirtyInputs = () =>
    [...table.querySelectorAll("input[data-original]")]
      .some((el) => el.value !== el.dataset.original);

  // Store original values for dirty checking
  table.querySelectorAll("input[type='text']").forEach((input) => {
    input.dataset.original = input.value;
  });

  // Submit on Enter key
  table.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && e.target.matches("input, select")) {
      e.preventDefault();
      e.target.closest("tr").querySelector("[hx-post]")?.click();
    }
  });

  // Intercept link navigation when inputs are dirty
  table.closest("body").addEventListener("click", (e) => {
    const link = e.target.closest("a[href]");
    if (!link || !hasDirtyInputs()) return;

    e.preventDefault();
    leaveBtn.onclick = () => {
      globalThis.removeEventListener("beforeunload", globalThis._destBeforeUnload);
      globalThis.location.href = link.href;
    };
    dialog.showModal();
  });

  stayBtn.addEventListener("click", () => dialog.close());

  // Fallback for browser/tab close
  if (!globalThis._destBeforeUnload) {
    globalThis._destBeforeUnload = (e) => {
      if (hasDirtyInputs()) {
        e.preventDefault();
        e.returnValue = "";
      }
    };
    globalThis.addEventListener("beforeunload", globalThis._destBeforeUnload);
  }
})();
</script>
