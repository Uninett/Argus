<!-- htmx/incident/cells/_incident_filterable_column_header_content.html -->
{% load argus_htmx %}
{% with field=form|get_form_field:fieldname %}
  <div class="flex items-center gap-1">
    <span id="{{ field.name }}-label">{{ column.label }}</span>
    {% include "htmx/incident/cells/_incident_sort_button.html" %}
    {# Filter dropdown #}
    <div id="{{ column.name }}-dropdown" class="dropdown dropdown-end">
      <button type="button"
              tabindex="0"
              aria-label="Filter by {{ column.label|lower }}"
              aria-controls="{{ column.name }}-dropdown-content"
              class="filter-btn btn btn-xs {% if field.value %} btn-primary {% else %} btn-ghost text-primary {% endif %} min-h-4 h-4">
        <i class="fa-solid fa-magnifying-glass"></i>
      </button>
      <div id="{{ column.name }}-dropdown-content"
           class="dropdown-content bg-base-100 p-2 mt-1 rounded-lg shadow border border-primary z-10"
           tabindex="-1">
        <form class="flex gap-2 incident-list-param"
          {# djlint:off #}
            {% if not dummy_column %}
            hx-get="{% url 'htmx:incident-list' %}"
            hx-include=".incident-list-param"
            hx-target="#table"
            hx-swap="outerHTML"
            hx-push-url="true"
            hx-indicator="#incident-list .htmx-indicator"
            {% endif %}>
          {# djlint:on #}
          <div aria-labelledby="{{ field.name }}-label">{{ field }}</div>
          <button type="submit" class="btn btn-xs btn-primary">Filter</button>
        </form>
      </div>
    </div>
  </div>
{% endwith %}
<script>
document.querySelector('#{{ column.name }}-dropdown .filter-btn').addEventListener('focus', function() {
  const dropdown = this.closest('.dropdown');
  const content = dropdown.querySelector('.dropdown-content');
  const rect = content.getBoundingClientRect();

  if (rect.right > window.innerWidth) {
    dropdown.classList.add('dropdown-end');
  } else if (rect.left < 0) {
    dropdown.classList.remove('dropdown-end');
  }
});
</script>
